# ChatAI Backend 架构设计

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        前端 (Expo)                           │
│                    WebSocket 客户端                          │
└────────────────────────┬────────────────────────────────────┘
                         │ WebSocket
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                    API 层 (FastAPI)                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ HTTP Routes  │  │  WebSocket   │  │  Middleware  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                    服务层 (Services)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ Audio Service│  │ Stream Service│  │Context Service│    │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                    AI 代理层 (Agent)                         │
│  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────────┐    │
│  │ VAD  │→ │ ASR  │→ │ LLM  │→ │ TTS  │→ │WebSocket │    │
│  └──────┘  └──────┘  └──────┘  └──────┘  └──────────┘    │
└─────────────────────────────────────────────────────────────┘
```

## 数据流

### 1. 用户说话流程
```
用户说话 
  → 前端录音 
  → WebSocket 发送音频流
  → VAD 检测语音活动
  → ASR 转录为文本
  → LLM 生成回复
  → TTS 合成语音
  → WebSocket 返回音频流
  → 前端播放
```

### 2. 打断机制
```
用户打断
  → VAD 检测到新语音
  → 停止当前 TTS 播放
  → 清空响应队列
  → 重新开始 ASR 识别
```

## 模块职责

### API 层
- **routes/**: 路由定义
  - `health.py`: 健康检查
  - `websocket.py`: WebSocket 连接管理
- **middleware/**: 中间件
  - 认证、日志、错误处理等

### 核心层 (core/)
- **config/**: 配置管理
  - `settings.py`: 环境变量和配置
- **audio/**: 音频处理
  - 格式转换、降噪、重采样
- **stream/**: 流式处理
  - 音频流、文本流管理
- **context/**: 上下文管理
  - 对话历史、会话状态

### AI 代理层 (agent/)
- **vad/**: 语音活动检测
  - 检测用户何时说话
  - 触发 ASR 处理
- **asr/**: 语音识别
  - 音频转文本
  - 支持流式识别
- **llm/**: 大语言模型
  - 生成对话回复
  - 支持流式生成
- **tts/**: 语音合成
  - 文本转语音
  - 支持流式合成

### 服务层 (services/)
- 业务逻辑封装
- 协调各个 AI 模块
- 处理复杂的业务流程

### 工具层 (utils/)
- 通用工具函数
- 音频处理工具
- 日志工具等

## 技术选型

### Web 框架
- **FastAPI**: 高性能异步框架
- **Uvicorn**: ASGI 服务器
- **WebSocket**: 实时双向通信

### AI 模型
- **ASR**: Whisper / FunASR
- **LLM**: OpenAI API / 本地模型
- **TTS**: Edge-TTS / Coqui TTS
- **VAD**: Silero VAD

### 音频处理
- **librosa**: 音频分析
- **pydub**: 音频格式转换
- **numpy**: 数值计算

### 其他
- **loguru**: 日志管理
- **pydantic**: 数据验证
- **pytest**: 单元测试

## 性能优化

### 1. 流式处理
- 所有模块支持流式输入输出
- 降低首字延迟 (TTFT)
- 提升用户体验

### 2. 异步并发
- 使用 asyncio 异步处理
- 支持多用户并发
- 资源高效利用

### 3. 缓存机制
- TTS 结果缓存
- 模型预加载
- 减少重复计算

### 4. 队列管理
- 请求队列
- 优先级调度
- 超时处理

## 部署方案

### 开发环境
```bash
python main.py
```

### 生产环境
```bash
# 使用 Gunicorn + Uvicorn
gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker

# 或使用 Docker
docker build -t chatai-backend .
docker run -p 8000:8000 chatai-backend
```

### 容器化
```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["python", "main.py"]
```

## 监控与日志

### 日志级别
- DEBUG: 详细调试信息
- INFO: 一般信息
- WARNING: 警告信息
- ERROR: 错误信息

### 监控指标
- 请求延迟
- 并发连接数
- 模型推理时间
- 错误率

## 安全考虑

1. **认证授权**: JWT Token
2. **CORS 配置**: 限制跨域访问
3. **速率限制**: 防止滥用
4. **输入验证**: 防止注入攻击
5. **敏感信息**: 环境变量管理

## 扩展性

### 水平扩展
- 无状态设计
- 负载均衡
- 分布式部署

### 模块化
- 插件式架构
- 易于替换模型
- 支持多种实现

## 开发规范

### 代码风格
- 遵循 PEP 8
- 使用类型注解
- 编写文档字符串

### 测试
- 单元测试覆盖率 > 80%
- 集成测试
- 性能测试

### Git 工作流
- 功能分支开发
- Code Review
- CI/CD 自动化
